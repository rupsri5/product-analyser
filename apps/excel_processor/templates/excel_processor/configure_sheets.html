{% extends 'base.html' %}
{% load excel_processor_filters %}

{% block content %}
<div class="container mt-4">
    <h2>Configure Sheets for {{ excel_file.name }}</h2>
    
    <ul class="nav nav-tabs" id="sheetTabs" role="tablist">
        {% for sheet_name in excel_file.sheet_names %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if forloop.first %}active{% endif %}" 
                    id="tab-{{ sheet_name }}" 
                    data-bs-toggle="tab" 
                    data-bs-target="#content-{{ sheet_name }}" 
                    type="button" role="tab" 
                    aria-controls="{{ sheet_name }}" 
                    aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                {{ sheet_name }}
            </button>
        </li>
        {% endfor %}
    </ul>
    
    <div class="tab-content mt-3" id="sheetTabsContent">
        {% for sheet_name in excel_file.sheet_names %}
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
             id="content-{{ sheet_name }}" 
             role="tabpanel" 
             aria-labelledby="tab-{{ sheet_name }}">
            
            <form id="form-{{ sheet_name }}" class="sheet-config-form">
                {% csrf_token %}
                <input type="hidden" name="sheet_name" value="{{ sheet_name }}">
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="enabled-{{ sheet_name }}" name="is_enabled"
                           {% if excel_file.sheet_config|get_item:sheet_name|get_item:'is_enabled' %}checked{% endif %}>
                    <label class="form-check-label" for="enabled-{{ sheet_name }}">
                        Enable this sheet
                    </label>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h4>Filter Columns (Dropdowns)</h4>
                        <select class="form-select" name="filter_columns[]" multiple size="10">
                            {% for column in sheet_columns|get_item:sheet_name %}
                            <option value="{{ column }}"
                                    {% if column in excel_file.sheet_config|get_item:sheet_name|get_item:'filter_columns' %}selected{% endif %}>
                                {{ column }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <h4>Result Columns</h4>
                        <select class="form-select" name="result_columns[]" multiple size="10">
                            <option value="total" selected disabled>total (Always included)</option>
                            {% for column in sheet_columns|get_item:sheet_name %}
                            <option value="{{ column }}"
                                    {% if column in excel_file.sheet_config|get_item:sheet_name|get_item:'result_columns' %}selected{% endif %}>
                                {{ column }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sheet-config-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            formData.set('is_enabled', this.querySelector('input[name="is_enabled"]').checked);
            
            fetch('{% url "excel_processor:configure_sheets" excel_file.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Configuration saved successfully!');
                } else {
                    alert('Error saving configuration: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
        });
    });
});
</script>
{% endblock %}
